/* Выведите среднее число учебных заведений (всех, не только уникальных), которые окончили сотрудники Socialnet. */
WITH a1 AS (
  -- Создаём временную таблицу с уникальными названиями закрытых компаний,
  -- для которых первый раунд финансирования оказался последним
  SELECT DISTINCT name
  FROM company AS c
  WHERE status = 'closed'  -- Только закрытые компании
  AND c.id IN (
    -- Выбираем компании, которые участвовали как в первом, так и в последнем раунде
    SELECT company_id
    FROM funding_round
    WHERE is_first_round = 1 
    AND is_last_round = 1
  )
)

-- Основной запрос для подсчёта среднего числа учебных заведений для сотрудников компании 'Facebook'
SELECT AVG(ins)  -- Выводим среднее количество учебных заведений (всех, включая повторения)
FROM (
    -- Вложенный запрос для подсчёта числа учебных заведений для каждого сотрудника
    SELECT e.person_id AS unique,  -- Уникальный номер сотрудника
           COUNT(e.instituition) AS ins  -- Количество учебных заведений (все, включая повторения)
    FROM education AS e
    -- Фильтруем сотрудников, которые работают в компании 'Facebook'
    WHERE e.person_id IN (
        SELECT p.id
        FROM people AS p
        LEFT JOIN company AS c ON p.company_id = c.id
        WHERE c.name = 'Facebook'  -- Компания 'Facebook' (замените на 'Socialnet' или нужное название, если это другая компания)
    )
    -- Группируем по id сотрудника
    GROUP BY e.person_id
) AS t1;  -- Оборачиваем результаты в подзапрос для подсчёта среднего значения
