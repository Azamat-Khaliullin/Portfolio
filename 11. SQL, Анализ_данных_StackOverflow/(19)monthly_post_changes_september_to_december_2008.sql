-- Задание: На сколько процентов менялось количество постов ежемесячно с 1 сентября по 31 декабря 2008 года?
-- Отобразите таблицу со следующими полями:
-- 1. Номер месяца.
-- 2. Количество постов за месяц.
-- 3. Процент изменения количества постов по сравнению с предыдущим месяцем.
-- Если постов стало меньше, значение процента должно быть отрицательным, если больше — положительным.
-- Округлите значение процента до двух знаков после запятой.
-- Напомним, что при делении одного целого числа на другое в PostgreSQL в результате получится целое число, округлённое до ближайшего целого вниз.
-- Чтобы этого избежать, переведите делимое в тип numeric.

SELECT
    EXTRACT('month' FROM DATE_TRUNC('month', creation_date)::date) AS month_number,  -- Номер месяца
    COUNT(id) AS cnt,                                                               -- Количество постов за месяц
    ROUND(
        CAST(COUNT(id) AS numeric) * 100 / LAG(COUNT(id), 1) OVER (ORDER BY DATE_TRUNC('month', creation_date)::date) - 100,  -- Процент изменения
        2                                                                            -- Округление до двух знаков после запятой
    ) AS percent_change
FROM stackoverflow.posts
WHERE creation_date::date BETWEEN '2008-09-01' AND '2008-12-31'                    -- Период с сентября по декабрь 2008 года
GROUP BY DATE_TRUNC('month', creation_date)::date                                  -- Группировка по началу месяца
ORDER BY month_number;                                                             -- Сортировка по номеру месяца
