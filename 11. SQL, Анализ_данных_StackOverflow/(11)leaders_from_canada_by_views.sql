-- Задание: Выведите лидеров каждой группы пользователей из Канады в зависимости от количества просмотров профиля.
-- Лидеры — это пользователи, которые набрали максимальное число просмотров в своей группе.
-- Отобразите идентификатор пользователя, группу и количество просмотров.
-- Отсортируйте результаты по убыванию просмотров, а затем по возрастанию идентификатора.

-- Основной запрос для получения лидеров каждой группы
SELECT
    id,                                      -- Идентификатор пользователя
    rtt.group,                               -- Группа пользователя
    views                                    -- Количество просмотров профиля
FROM (
    -- Подзапрос для определения ранга пользователей внутри каждой группы
    SELECT
        id,
        views,
        rtt.group,
        DENSE_RANK() OVER (PARTITION BY rtt.group ORDER BY views DESC) AS rnn -- Ранжирование пользователей по количеству просмотров в своей группе
    FROM (
        -- Подзапрос для присвоения группы каждому пользователю в зависимости от количества просмотров
        SELECT
            id,
            views,
            CASE
                WHEN views >= 350 THEN 1        -- Группа 1: просмотры >= 350
                WHEN views >= 100 THEN 2        -- Группа 2: 100 <= просмотры < 350
                ELSE 3                          -- Группа 3: просмотры < 100
            END AS group
        FROM stackoverflow.users
        -- Фильтрация по местоположению и количеству просмотров
        WHERE location LIKE '%Canada%' AND views > 0
    ) AS rtt
) AS rtt
-- Фильтрация для получения только лидеров (пользователей с максимальным количеством просмотров в своей группе)
WHERE rnn = 1
-- Сортировка по убыванию количества просмотров, затем по возрастанию идентификатора пользователя
ORDER BY views DESC, id;
